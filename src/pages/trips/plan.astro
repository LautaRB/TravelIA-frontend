---
import Layout from "../../layouts/BaseLayout.astro";
---

<Layout title="Nuevo Viaje - TravelIA">
  <div
    class="min-h-screen bg-ocean-50 dark:bg-slate-900 relative transition-colors duration-300 pb-20"
  >
    <header
      class="bg-white dark:bg-slate-800 px-6 pt-12 pb-4 shadow-sm sticky top-0 z-10 flex items-center gap-4 transition-colors"
    >
      <a
        href="/dashboard/dashboard/index.html"
        class="p-2 -ml-2 text-ocean-600 dark:text-ocean-400 hover:bg-ocean-50 dark:hover:bg-slate-700 rounded-full transition"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-6 w-6"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          stroke-width="2"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M15 19l-7-7 7-7"></path>
        </svg>
      </a>
      <h1 class="text-xl font-bold text-ocean-900 dark:text-white">
        Planear Viaje
      </h1>
    </header>

    <main class="p-6">
      <div id="step-form">
        <div class="mb-8 text-center">
          <div
            class="inline-flex items-center justify-center p-3 bg-ocean-100 dark:bg-slate-800 rounded-full mb-4"
          >
            <span class="text-3xl">‚ú®</span>
          </div>
          <h2 class="text-2xl font-bold text-ocean-900 dark:text-white">
            ¬øA d√≥nde vamos?
          </h2>
          <p class="text-ocean-400 dark:text-slate-400 text-sm mt-1">
            Contanos tu idea y la IA armar√° el plan.
          </p>
        </div>

        <form id="planTripForm" class="space-y-5">
          <div class="space-y-1">
            <label
              class="text-xs font-bold text-ocean-400 dark:text-slate-400 uppercase tracking-wider ml-1"
              >Nombre del Viaje</label
            >
            <input
              type="text"
              id="titulo"
              placeholder="Ej: Eurotrip 2025"
              class="w-full px-4 py-3 bg-white dark:bg-slate-800 border border-ocean-100 dark:border-slate-700 rounded-xl text-ocean-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-ocean-500 transition-colors"
              required
            />
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div class="space-y-1">
              <label
                class="text-xs font-bold text-ocean-400 dark:text-slate-400 uppercase tracking-wider ml-1"
                >Origen</label
              >
              <input
                type="text"
                id="origen"
                placeholder="Madrid"
                class="w-full px-4 py-3 bg-white dark:bg-slate-800 border border-ocean-100 dark:border-slate-700 rounded-xl text-ocean-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-ocean-500 transition-colors"
                required
              />
            </div>
            <div class="space-y-1">
              <label
                class="text-xs font-bold text-ocean-400 dark:text-slate-400 uppercase tracking-wider ml-1"
                >Destino</label
              >
              <input
                type="text"
                id="destino"
                placeholder="Par√≠s"
                class="w-full px-4 py-3 bg-white dark:bg-slate-800 border border-ocean-100 dark:border-slate-700 rounded-xl text-ocean-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-ocean-500 transition-colors"
                required
              />
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div class="space-y-1">
              <label
                class="text-xs font-bold text-ocean-400 dark:text-slate-400 uppercase tracking-wider ml-1"
                >Desde</label
              >
              <input
                type="date"
                id="fecha_inicio"
                class="w-full px-4 py-3 bg-white dark:bg-slate-800 border border-ocean-100 dark:border-slate-700 rounded-xl text-ocean-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-ocean-500 transition-colors"
                required
              />
            </div>
            <div class="space-y-1">
              <label
                class="text-xs font-bold text-ocean-400 dark:text-slate-400 uppercase tracking-wider ml-1"
                >Hasta</label
              >
              <input
                type="date"
                id="fecha_fin"
                class="w-full px-4 py-3 bg-white dark:bg-slate-800 border border-ocean-100 dark:border-slate-700 rounded-xl text-ocean-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-ocean-500 transition-colors"
                required
              />
            </div>
          </div>

          <div class="pt-4">
            <button
              type="submit"
              id="btnPlanear"
              class="w-full bg-gradient-to-r from-ocean-500 to-ocean-600 hover:from-ocean-600 hover:to-ocean-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-ocean-200 dark:shadow-none transform transition active:scale-[0.98] flex justify-center items-center gap-2"
            >
              <span id="btnText">Generar Itinerario con IA</span>
            </button>
          </div>
        </form>
      </div>

      <div
        id="step-loading"
        class="hidden flex-col items-center justify-center py-20 text-center space-y-4"
      >
        <div class="relative w-20 h-20">
          <div
            class="absolute top-0 left-0 w-full h-full border-4 border-ocean-200 rounded-full animate-pulse"
          >
          </div>
          <div
            class="absolute top-0 left-0 w-full h-full border-4 border-ocean-600 rounded-full border-t-transparent animate-spin"
          >
          </div>
        </div>
        <h3 class="text-xl font-bold text-ocean-900 dark:text-white">
          Consultando a Gemini...
        </h3>
        <p class="text-ocean-400 dark:text-slate-400 text-sm max-w-xs mx-auto">
          La IA est√° analizando las mejores rutas y precios para tu viaje.
        </p>
      </div>

      <div id="step-results" class="hidden space-y-8">
        <div class="text-center">
          <h2 class="text-2xl font-bold text-ocean-900 dark:text-white">
            Elige tu Aventura
          </h2>
          <p class="text-ocean-400 dark:text-slate-400 text-sm">
            Selecciona una ruta y un medio de transporte.
          </p>
        </div>

        <div>
          <h3
            class="text-sm font-bold text-ocean-400 dark:text-slate-400 uppercase tracking-wider mb-3"
          >
            1. Rutas Disponibles
          </h3>
          <div id="routes-container" class="space-y-3"></div>
        </div>

        <div>
          <h3
            class="text-sm font-bold text-ocean-400 dark:text-slate-400 uppercase tracking-wider mb-3"
          >
            2. Medio de Transporte
          </h3>
          <div id="media-container" class="space-y-3"></div>
        </div>

        <div class="pt-4 pb-10">
          <button
            id="btnConfirmar"
            disabled
            class="w-full bg-green-600 hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-white font-bold py-4 rounded-xl shadow-lg transition-all flex justify-center items-center gap-2"
          >
            Confirmar y Guardar Viaje
          </button>
        </div>
      </div>
    </main>
  </div>
</Layout>

<script>
  const BASE_URL = import.meta.env.PUBLIC_API_BASE_URL;

  function getCookie(name: string): string | null {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop()?.split(";").shift() || null;
    return null;
  }

  const stepForm = document.getElementById("step-form");
  const stepLoading = document.getElementById("step-loading");
  const stepResults = document.getElementById("step-results");
  const form = document.getElementById("planTripForm");
  const btnPlanear = document.getElementById("btnPlanear");
  const btnConfirmar = document.getElementById(
    "btnConfirmar"
  ) as HTMLButtonElement;
  const routesContainer = document.getElementById("routes-container");
  const mediaContainer = document.getElementById("media-container");

  let planData: any = null;
  let selectedRouteIndex: number | null = null;
  let selectedMediaIndex: number | null = null;
  let formValues: any = null;

  const fechaInicioInput = document.getElementById(
    "fecha_inicio"
  ) as HTMLInputElement;
  const fechaFinInput = document.getElementById(
    "fecha_fin"
  ) as HTMLInputElement;

  function setupDateValidation() {
    if (!fechaInicioInput || !fechaFinInput) return;

    const today = new Date().toISOString().split("T")[0];

    fechaInicioInput.min = today;
    fechaFinInput.min = today;

    fechaInicioInput.addEventListener("change", function () {
      const startDate = this.value;

      fechaFinInput.min = startDate;

      if (fechaFinInput.value && fechaFinInput.value < startDate) {
        fechaFinInput.value = "";
        alert(
          "La fecha de regreso se ha reiniciado porque debe ser posterior a la ida."
        );
      }
    });
  }

  setupDateValidation();

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();

    formValues = {
      titulo: (document.getElementById("titulo") as HTMLInputElement).value,
      origen: (document.getElementById("origen") as HTMLInputElement).value,
      destino: (document.getElementById("destino") as HTMLInputElement).value,
      fecha_inicio: (
        document.getElementById("fecha_inicio") as HTMLInputElement
      ).value,
      fecha_fin: (document.getElementById("fecha_fin") as HTMLInputElement)
        .value,
    };

    stepForm?.classList.add("hidden");
    stepLoading?.classList.remove("hidden");

    try {
      const token = getCookie("authToken");

      const response = await fetch(`${BASE_URL}/viajes/planificar/`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify({
          origen: formValues.origen,
          destino: formValues.destino,
          fecha_inicio: formValues.fecha_inicio,
          fecha_fin: formValues.fecha_fin,
        }),
      });

      const data = await response.json();

      if (!response.ok) throw new Error(data.message || "Error al planificar");

      planData = data.opciones;
      renderOptions();

      stepLoading?.classList.add("hidden");
      stepResults?.classList.remove("hidden");
    } catch (error: any) {
      alert("Error: " + error.message);
      stepLoading?.classList.add("hidden");
      stepForm?.classList.remove("hidden");
    }
  });

  function renderOptions() {
    if (!routesContainer || !mediaContainer || !planData) return;

    routesContainer.innerHTML = "";
    planData.rutas.forEach((ruta: any, index: number) => {
      const card = document.createElement("div");
      card.className = `p-4 rounded-xl border-2 cursor-pointer transition-all bg-white dark:bg-slate-800 ${selectedRouteIndex === index ? "border-ocean-500 ring-2 ring-ocean-200" : "border-gray-100 dark:border-slate-700 hover:border-ocean-300"}`;
      card.innerHTML = `
            <div class="flex justify-between items-center mb-1">
                <h4 class="font-bold text-ocean-900 dark:text-white">${ruta.nombre}</h4>
                ${selectedRouteIndex === index ? '<span class="text-ocean-500">‚úÖ</span>' : ""}
            </div>
            <div class="flex gap-4 text-sm text-gray-500 dark:text-slate-400">
                <span class="flex items-center gap-1">üìè ${ruta.distancia} (Distancia)</span>
                <span class="flex items-center gap-1">‚è±Ô∏è ${ruta.duracion_horas}h</span>
            </div>
          `;
      card.onclick = () => selectRoute(index);
      routesContainer.appendChild(card);
    });

    mediaContainer.innerHTML = "";
    planData.medios.forEach((medio: any, index: number) => {
      const card = document.createElement("div");
      card.className = `p-4 rounded-xl border-2 cursor-pointer transition-all bg-white dark:bg-slate-800 ${selectedMediaIndex === index ? "border-ocean-500 ring-2 ring-ocean-200" : "border-gray-100 dark:border-slate-700 hover:border-ocean-300"}`;
      card.innerHTML = `
            <div class="flex justify-between items-center mb-1">
                <h4 class="font-bold text-ocean-900 dark:text-white">${medio.nombre}</h4>
                ${selectedMediaIndex === index ? '<span class="text-ocean-500">‚úÖ</span>' : ""}
            </div>
            <div class="flex justify-between text-sm">
                <span class="px-2 py-0.5 rounded bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-slate-300 text-xs font-bold uppercase">${medio.tipo}</span>
                <span class="font-bold text-ocean-600 dark:text-ocean-400 text-lg">$ ${medio.precio}</span>
            </div>
          `;
      card.onclick = () => selectMedia(index);
      mediaContainer.appendChild(card);
    });

    updateConfirmButton();
  }

  function selectRoute(index: number) {
    selectedRouteIndex = index;
    renderOptions();
  }

  function selectMedia(index: number) {
    selectedMediaIndex = index;
    renderOptions();
  }

  function updateConfirmButton() {
    if (selectedRouteIndex !== null && selectedMediaIndex !== null) {
      btnConfirmar.disabled = false;
      btnConfirmar.innerHTML = "Confirmar y Guardar Viaje";
    } else {
      btnConfirmar.disabled = true;
      btnConfirmar.innerHTML = "Selecciona una opci√≥n de cada lista";
    }
  }

  btnConfirmar.addEventListener("click", () => {
    const seleccion = {
      ...formValues,
      ruta_elegida: planData.rutas[selectedRouteIndex!],
      medio_elegido: planData.medios[selectedMediaIndex!],
    };
    console.log("LISTO PARA GUARDAR:", seleccion);
    alert(
      "¬°Genial! Has seleccionado tu viaje. (En el pr√≥ximo paso lo guardamos en BD)"
    );
  });
</script>
