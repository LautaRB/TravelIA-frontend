---
import Layout from "../../layouts/BaseLayout.astro";
---

<Layout title="Editar Viaje">
  <div class="min-h-screen bg-ocean-50 dark:bg-slate-900 pb-24 transition-colors">
    
    <header class="bg-white dark:bg-slate-800 shadow-sm sticky top-0 z-10 px-4 py-3 flex items-center gap-3">
        <button id="cancel-btn" class="text-sm font-medium text-gray-500 hover:text-gray-700">Cancelar</button>
        <h1 class="flex-1 text-center text-lg font-bold text-ocean-900 dark:text-white">Editar Viaje</h1>
        <button id="save-btn" class="text-sm font-bold text-ocean-600 hover:text-ocean-700">Guardar</button>
    </header>

    <main class="px-6 mt-6">
        <form id="edit-form" class="space-y-5">
            
            <div class="flex flex-col gap-1">
                <label class="text-xs font-bold text-ocean-700 uppercase">Título del Viaje</label>
                <input type="text" id="titulo" name="titulo" class="w-full p-3 rounded-xl border border-gray-200 focus:border-ocean-500 focus:ring-1 focus:ring-ocean-500 outline-none transition dark:bg-slate-800 dark:border-slate-600 dark:text-white" required />
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="flex flex-col gap-1">
                    <label class="text-xs font-bold text-ocean-700 uppercase">Inicio</label>
                    <input type="date" id="fecha_inicio" name="fecha_inicio" class="w-full p-3 rounded-xl border border-gray-200 dark:bg-slate-800 dark:border-slate-600 dark:text-white" required />
                </div>
                <div class="flex flex-col gap-1">
                    <label class="text-xs font-bold text-ocean-700 uppercase">Fin</label>
                    <input type="date" id="fecha_fin" name="fecha_fin" class="w-full p-3 rounded-xl border border-gray-200 dark:bg-slate-800 dark:border-slate-600 dark:text-white" required />
                </div>
            </div>

            <div class="flex flex-col gap-1">
                <label class="text-xs font-bold text-ocean-700 uppercase">Origen</label>
                <input type="text" id="origen" name="origen" class="w-full p-3 rounded-xl border border-gray-200 dark:bg-slate-800 dark:border-slate-600 dark:text-white" required />
            </div>

             <div class="flex flex-col gap-1">
                <label class="text-xs font-bold text-ocean-700 uppercase">Destino</label>
                <input type="text" id="destino" name="destino" class="w-full p-3 rounded-xl border border-gray-200 dark:bg-slate-800 dark:border-slate-600 dark:text-white" required />
            </div>
        </form>
    </main>
  </div>
</Layout>

<script>
  const BASE_URL = import.meta.env.PUBLIC_API_BASE_URL || "https://travelia-backend.onrender.com/api";
  
  const form = document.getElementById('edit-form') as HTMLFormElement;
  const saveBtn = document.getElementById('save-btn') as HTMLButtonElement;
  const cancelBtn = document.getElementById('cancel-btn');
  const urlParams = new URLSearchParams(window.location.search);
  const tripId = urlParams.get('id');
  const token = localStorage.getItem('authToken');

  async function loadData() {
      if (!token || !tripId) {
          alert("No se identificó el viaje.");
          window.location.href = '/trips/index.html';
          return;
      }

      try {
          if(saveBtn) saveBtn.disabled = true;
          
          const res = await fetch(`${BASE_URL}/viajes/${tripId}/`, {
              headers: { 'Authorization': `Bearer ${token}` }
          });
          
          if (!res.ok) throw new Error("Error cargando datos");
          
          const data = await res.json();
          
          const setVal = (id: string, val: any) => {
              const el = document.getElementById(id) as HTMLInputElement;
              if(el) el.value = val || '';
          };

          setVal('titulo', data.titulo);
          setVal('origen', data.origen);
          setVal('destino', data.destino);
          setVal('fecha_inicio', data.fecha_inicio);
          setVal('fecha_fin', data.fecha_fin);
      } catch (e) {
          console.error(e);
          alert("No se pudieron cargar los datos del viaje.");
          window.location.href = '/trips/index.html';
      } finally {
          if(saveBtn) saveBtn.disabled = false;
      }
  }

  async function saveChanges(e: Event) {
      e.preventDefault();

      if (!form.checkValidity()) {
          form.reportValidity();
          return;
      }

      const originalText = saveBtn.innerText;
      saveBtn.innerText = "Actualizando itinerario...";
      saveBtn.disabled = true;
      saveBtn.classList.add('opacity-75', 'cursor-not-allowed');

      const formData = new FormData(form);
      const payload = Object.fromEntries(formData.entries());

      try {
          const res = await fetch(`${BASE_URL}/viajes/${tripId}/`, {
              method: 'PATCH',
              headers: { 
                  'Authorization': `Bearer ${token}`,
                  'Content-Type': 'application/json'
              },
              body: JSON.stringify(payload)
          });

          const json = await res.json();

          if (res.ok) {
              window.location.replace(`/trips/detail/index.html?id=${tripId}`); 
          } else {
              alert(json.message || json.detail || "No se pudo actualizar el viaje. Intenta nuevamente.");
          }

      } catch (error) {
          console.error(error);
          alert("Error de conexión con el servidor.");
      } finally {
          saveBtn.innerText = originalText;
          saveBtn.disabled = false;
          saveBtn.classList.remove('opacity-75', 'cursor-not-allowed');
      }
  }

  loadData();

  saveBtn?.addEventListener('click', saveChanges);
  cancelBtn?.addEventListener('click', () => window.history.back());

</script>