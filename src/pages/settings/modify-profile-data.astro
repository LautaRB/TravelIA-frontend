---
import Layout from "../../layouts/BaseLayout.astro";
---

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />

<Layout title="Modificar mis datos - TravelIA">
  <div class="min-h-screen bg-ocean-50 dark:bg-slate-900 relative transition-colors duration-300">
    
    <header class="bg-white dark:bg-slate-800 px-6 pt-12 pb-4 shadow-sm sticky top-0 z-10 flex items-center gap-4 transition-colors">
      <a
        href="/settings/profile/index.html"
        class="p-2 -ml-2 text-ocean-600 dark:text-ocean-400 hover:bg-ocean-50 dark:hover:bg-slate-700 rounded-full transition"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"></path>
        </svg>
      </a>
      <h1 class="text-xl font-bold text-ocean-900 dark:text-white">
        Modificar mis datos
      </h1>
    </header>

    <main class="p-6">
      <div class="bg-white dark:bg-slate-800 rounded-3xl p-6 shadow-sm shadow-ocean-100 dark:shadow-none flex flex-col items-center text-center border border-ocean-50 dark:border-slate-700 transition-colors">
        
        <div class="relative mb-6">
          <div class="w-28 h-28 rounded-full bg-ocean-100 dark:bg-slate-700 border-4 border-white dark:border-slate-600 shadow-md overflow-hidden relative group cursor-pointer" id="avatarContainer">
            <img 
              id="profile-image"
              alt="Avatar" 
              class="w-full h-full object-cover opacity-0 transition-opacity duration-500"
            />
            <div class="absolute inset-0 bg-black bg-opacity-30 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                <span class="text-white text-xs font-bold">Cambiar</span>
            </div>
          </div>
          
          <button id="cameraBtn" class="absolute bottom-0 right-0 bg-ocean-600 text-white p-2.5 rounded-full hover:bg-ocean-700 transition shadow-sm border-2 border-white dark:border-slate-800">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
          </button>

          <input type="file" id="fileInput" accept="image/*" class="hidden" />
        </div>

        <form id="profileForm" class="w-full space-y-4">
            
            <div class="text-left">
                <label class="text-xs font-bold text-ocean-400 dark:text-slate-400 uppercase tracking-wider ml-1">Usuario</label>
                <input 
                    type="text" 
                    id="usernameInput" 
                    class="w-full mt-1 px-4 py-3 bg-ocean-50 dark:bg-slate-900 border border-ocean-100 dark:border-slate-600 rounded-xl text-ocean-900 dark:text-white font-bold focus:outline-none focus:ring-2 focus:ring-ocean-500 transition-colors"
                    placeholder="Tu nombre de usuario"
                    required
                />
            </div>

            <div class="text-left">
                <label class="text-xs font-bold text-ocean-400 dark:text-slate-400 uppercase tracking-wider ml-1">Email</label>
                <input 
                    type="email" 
                    id="emailInput" 
                    class="w-full mt-1 px-4 py-3 bg-ocean-50 dark:bg-slate-900 border border-ocean-100 dark:border-slate-600 rounded-xl text-ocean-900 dark:text-white font-medium focus:outline-none focus:ring-2 focus:ring-ocean-500 transition-colors"
                    placeholder="tucorreo@ejemplo.com"
                    required
                />
            </div>

            <div class="pt-6 space-y-3">
                <button
                    id="submitBtn"
                    type="submit"
                    class="w-full bg-ocean-600 hover:bg-ocean-700 text-white font-bold py-3.5 rounded-xl transition shadow-lg shadow-ocean-200 dark:shadow-none flex justify-center items-center gap-2"
                >
                    <span>Guardar Cambios</span>
                </button>

                <a
                    href="/settings/profile/index.html"
                    class="w-full block bg-white dark:bg-slate-800 text-ocean-600 dark:text-slate-300 font-bold py-3.5 rounded-xl border border-ocean-200 dark:border-slate-600 hover:bg-gray-50 dark:hover:bg-slate-700 transition text-center"
                >
                    Cancelar
                </a>
            </div>
        </form>

      </div>
    </main>

    <div id="cropModal" class="fixed inset-0 bg-black bg-opacity-90 z-50 hidden flex-col justify-center items-center p-4">
        <div class="relative w-full max-w-sm bg-white dark:bg-slate-800 rounded-2xl overflow-hidden shadow-2xl">
            <div class="h-80 bg-black flex items-center justify-center">
                <img id="imageToCrop" class="max-w-full max-h-full block" />
            </div>
            
            <div class="p-4 flex justify-between gap-4 bg-white dark:bg-slate-800">
                <button id="cancelCropBtn" class="flex-1 py-2 px-4 border border-ocean-200 dark:border-slate-600 text-ocean-600 dark:text-slate-300 font-bold rounded-xl hover:bg-gray-50 dark:hover:bg-slate-700 transition">
                    Cancelar
                </button>
                <button id="confirmCropBtn" class="flex-1 py-2 px-4 bg-ocean-600 text-white font-bold rounded-xl hover:bg-ocean-700 transition shadow-md">
                    Recortar
                </button>
            </div>
        </div>
    </div>

  </div>
</Layout>

<script is:inline src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<script>
  import { getProfile, updateProfile } from "../../services/api/authAPI";

  declare const Cropper: any;

  function getCookie(name: string): string | null {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop()?.split(";").shift() || null;
    return null;
  }

  const avatarContainer = document.getElementById('avatarContainer');
  const cameraBtn = document.getElementById('cameraBtn');
  const fileInput = document.getElementById('fileInput') as HTMLInputElement;
  const profileImage = document.getElementById('profile-image') as HTMLImageElement;
  const usernameInput = document.getElementById('usernameInput') as HTMLInputElement;
  const emailInput = document.getElementById('emailInput') as HTMLInputElement;
  const form = document.getElementById('profileForm');
  const submitBtn = document.getElementById('submitBtn') as HTMLButtonElement;
  const cropModal = document.getElementById('cropModal');
  const imageToCrop = document.getElementById('imageToCrop') as HTMLImageElement;
  const cancelCropBtn = document.getElementById('cancelCropBtn');
  const confirmCropBtn = document.getElementById('confirmCropBtn');

  let cropper: any = null;
  let croppedBlob: Blob | null = null;

  async function loadData() {
      const token = getCookie('authToken');
      if (!token) return;

      try {
          const user = await getProfile(token);
          
          if (usernameInput) usernameInput.value = user.username;
          if (emailInput) emailInput.value = user.email;

          if (profileImage) {
             const fallbackUrl = "/default-penguin.png";
             const timestamp = new Date().getTime();
             
             profileImage.onload = () => profileImage.classList.remove('opacity-0');
             
             if (user.profile_picture) {
                 profileImage.src = `${user.profile_picture}${user.profile_picture.includes('?') ? '&' : '?'}t=${timestamp}`;
             } else {
                 profileImage.src = fallbackUrl;
             }
          }

      } catch (error) {
          console.error("Error cargando perfil", error);
      }
  }

  function triggerFileSelect() { fileInput.click(); }
  avatarContainer?.addEventListener('click', triggerFileSelect);
  cameraBtn?.addEventListener('click', triggerFileSelect);

  fileInput?.addEventListener('change', (e) => {
      const target = e.target as HTMLInputElement;
      if (target.files && target.files[0]) {
          const file = target.files[0];
          const reader = new FileReader();
          
          reader.onload = (ev) => {
              if (ev.target?.result) {
                  if (cropModal && imageToCrop) {
                      imageToCrop.src = ev.target.result as string;
                      cropModal.classList.remove('hidden');
                      
                      if (cropper) {
                          cropper.destroy();
                      }

                      cropper = new Cropper(imageToCrop, {
                          aspectRatio: 1,
                          viewMode: 1,
                          autoCropArea: 1,
                          background: false,
                      });
                  }
              }
          }
          reader.readAsDataURL(file);
      }
      target.value = ''; 
  });

  cancelCropBtn?.addEventListener('click', (e) => {
      e.preventDefault();
      cropModal?.classList.add('hidden');
      if (cropper) cropper.destroy();
      croppedBlob = null;
  });

  confirmCropBtn?.addEventListener('click', (e) => {
      e.preventDefault();
      if (!cropper) return;

      const canvas = cropper.getCroppedCanvas({
          width: 500,
          height: 500
      });

      canvas.toBlob((blob: Blob) => {
          croppedBlob = blob;
          
          const url = URL.createObjectURL(blob);
          profileImage.src = url;

          cropModal?.classList.add('hidden');
          cropper.destroy();
      }, 'image/jpeg', 0.9);
  });

  form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const token = getCookie('authToken');
      if (!token) return;

      const newUsername = usernameInput.value;
      const newEmail = emailInput.value;

      const originalText = submitBtn.innerText;
      submitBtn.innerHTML = `<span class="animate-pulse">Guardando...</span>`;
      submitBtn.disabled = true;

      try {
          let dataToSend;

          if (croppedBlob) {
              const formData = new FormData();
              formData.append('username', newUsername);
              formData.append('email', newEmail);
              formData.append('profile_picture', croppedBlob, 'profile_picture.jpg'); 
              dataToSend = formData;
          } else {
              dataToSend = { 
                  username: newUsername,
                  email: newEmail 
              };
          }

          await updateProfile(token, dataToSend);
          
          alert("Â¡Datos actualizados!");
          
          window.location.href = "/settings/profile/index.html";

      } catch (error: any) {
          console.error(error);
          alert("Error: " + error.message);
          submitBtn.disabled = false;
          submitBtn.innerText = originalText;
      }
  });

  loadData();
</script>